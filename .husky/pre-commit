#!/usr/bin/env sh

# Hook de Husky: minifica JS cambiados en src/ y scripts/
# - Maneja nombres con espacios/caracteres especiales usando -z y xargs -0 (compatible POSIX sh)
# - Convierte rutas a nombres sin extensiÃ³n y ejecuta npm por archivo
# - Agrega dist/ al commit

# Source husky shim if available (created by `husky install`)
# This makes the hook robust even if prepare hasn't run yet.
. "$(dirname -- "$0")/_/husky.sh" 2>/dev/null || true

set -eu

# Si hay archivos JS staged en src/ o scripts/ (excluye *.min.js), procesa uno por uno
if git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '^(src|scripts)/.*\.js$' | grep -v '\.min\.js$' >/dev/null 2>&1; then
  git diff --cached --name-only -z --diff-filter=ACMRTUXB \
  | xargs -0 -I {} sh -c '
      f="$1"
      case "$f" in
        src/*.js)
          case "$f" in *.min.js) exit 0;; esac
          name=${f##*/}; name=${name%.js}
          npm run -s minify -- --dir src "$name"
          ;;
        scripts/*.js)
          case "$f" in *.min.js) exit 0;; esac
          name=${f##*/}; name=${name%.js}
          npm run -s minify -- --dir scripts "$name"
          ;;
      esac
    ' sh {}
else
  echo "Husky: no JS sources changed under src/ or scripts/, skipping minify."
fi

# Include generated minified files in the commit
git add -A dist


