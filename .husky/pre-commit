#!/usr/bin/env sh

# Hook de Husky: minifica JS cambiados en src/ y scripts/
# - Procesa archivos con lectura null-terminated (-z) para soportar espacios/caracteres especiales
# - Convierte rutas a nombres sin extensiÃ³n y ejecuta npm por archivo (citado de forma segura)
# - Agrega dist/ al commit

# Source husky shim if available (created by `husky install`)
# This makes the hook robust even if prepare hasn't run yet.
. "$(dirname -- "$0")/_/husky.sh" 2>/dev/null || true

set -eu

# Recorre archivos staged null-terminated, filtra por src/ y scripts/, y evita *.min.js
git diff --cached --name-only -z --diff-filter=ACMRTUXB \
| while IFS= read -r -d '' f; do
  case "$f" in
    src/*.js)
      case "$f" in *.min.js) continue;; esac
      name=${f##*/}; name=${name%.js}
      npm run -s minify -- --dir src "$name"
      ;;
    scripts/*.js)
      case "$f" in *.min.js) continue;; esac
      name=${f##*/}; name=${name%.js}
      npm run -s minify -- --dir scripts "$name"
      ;;
  esac
done

# Nota: si no hubo archivos coincidentes, el bucle no ejecuta nada.
# Dejamos un mensaje informativo, pero no tratamos como error.
if [ -z "$(git diff --cached --name-only --diff-filter=ACMRTUXB | grep -E '^(src|scripts)/.*\.js$' | grep -v '\.min\.js$' || true)" ]; then
  echo "Husky: no JS sources changed under src/ or scripts/, skipping minify."
fi

# Include generated minified files in the commit
git add -A dist


